<?xml version="1.0" encoding="UTF-8"?>
<custombutton xmlns:cb="http://xsms.nm.ru/custombuttons/" xmlns:html="http://www.w3.org/1999/xhtml">
<html:head>
	<html:title><![CDATA[Toolbars Toggler]]></html:title>
	<html:link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABC0lEQVQ4jZXTMUpDQRSF4Y8IKu5BEcSFhFhZqGAKiRjRMq0opLAQRLC0ElyBRdSANlmBmFWIuAWJ+hJj8W4kKDrPAxcezDv/nJl7h1wVPOAdw0T10cWSMXMfLdRQTVQN1+GpiJ1b0prBZZj30A6vN2wWAKxhJ75vsR1H9ojjAoB5dNCIJKfhdYBepJhKQOawgl28Yh9KOMNAugOjGoSnNE6fDXqqC6uR5IcW44eNRFWxMG6cwMU/4g/xgfPwOsQLtrAuv+2/NCkfph6a8Iwj3Mhvt/PbGb/pBE+QBbEdCw0sFwB8DVJXPp5N+YRdYboA4A735K+qHwnq0l2ohzlDeUQbPedMugNZ7FyGT86iazwwv55zAAAAAElFTkSuQmCC"/>
	<html:style type="text/css"><![CDATA[body{font-size:medium;margin:0}body,code:before,help:before,initcode:before{font-family:"Verdana",sans-serif}#wrapper{position:fixed;top:1em;right:1em;max-width:15%;text-align:center}#button{background-color:#299a0b;border:1px solid #3a7404;border-radius:.5em;padding:0;margin-bottom:1em;box-shadow:1px 2px 3px rgba(0,0,0,.25)}#button a{color:#f0f0f0;font-weight:700;text-shadow:-.5pt -.5px .5pt rgba(0,0,0,1);padding:.8em;text-decoration:none}:-moz-any-link:focus{color:grey;outline-color:transparent;text-decoration:none}#button a,code,code:before,initcode,initcode:before,help,help:before{display:block}#credits{position:fixed;bottom:1em;right:1em;font-size:small}#about{font-size:small}custombutton{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABAElEQVQ4jW2TQXLFMAhDff+b2vEHYw5AF38eVTNdZAIxCEkmw31VptU5T7mvOuepc56K2B2f85TZrEwr99VxptUwm2U2695PZVrH937KfZX76txsVsTus0yrEbEr0/4F4AyQc56eDMiI2F0IbYoj9h9ZSCV2XzXUA1BVL8BvBvSMiN20zWY38VZ5gDEkYtfAYTRToA3qiQJk2hcA7W8gpaxG0nPvp4aiQ5UCzOV2GKAgLUEfpsGCfaBR92TonapmdCoAjHTIgLa6/14gbgow8oj9uwe6SMQ0qTz9P9oDZOgCkfMNJnqWaV8P3ouDRorUXEA4H1wbtMmVjcrQ7TSb9QMtXcwa4wpbXgAAAABJRU5ErkJggg==) fixed #f6f6f1;margin:1em}date,image,mode,accelkey{display:none}name{font-weight:700;font-size:x-large}code:before,help:before,initcode:before{font-weight:700;font-size:large;margin:0 0 1em;padding:.5em}code:before{content:"Code Tab"}help:before{content:"Help Tab"}initcode:before{content:"Initialization Code Tab"}code,initcode,help{background-color:#fcfcfc;font-size:.875em;font-family:Consolas,"Bitstream Vera Sans Mono","Courier New",Courier,monospace!important;margin:1em 2em 1em 0 !important;padding:1em;text-align:left;box-shadow:2px 2px 0 rgba(170,160,130,0.5),4px 4px 0 rgba(200,190,165,0.5);max-width:80%;min-width:80%;white-space:pre-wrap;word-wrap:break-word}]]></html:style>
</html:head>
<html:body>
	<html:div id="wrapper">
		<html:div id="button">
			<html:a href="custombutton://%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%0A%3Ccustombutton%20xmlns%3Acb%3D%22http%3A//xsms.nm.ru/custombuttons/%22%3E%0A%20%20%3Cname%3EToolbars%20Toggler%3C/name%3E%0A%20%20%3Cimage%3E%3C%21%5BCDATA%5Bdata%3Aimage/png%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABC0lEQVQ4jZXTMUpDQRSF4Y8IKu5BEcSFhFhZqGAKiRjRMq0opLAQRLC0ElyBRdSANlmBmFWIuAWJ+hJj8W4kKDrPAxcezDv/nJl7h1wVPOAdw0T10cWSMXMfLdRQTVQN1+GpiJ1b0prBZZj30A6vN2wWAKxhJ75vsR1H9ojjAoB5dNCIJKfhdYBepJhKQOawgl28Yh9KOMNAugOjGoSnNE6fDXqqC6uR5IcW44eNRFWxMG6cwMU/4g/xgfPwOsQLtrAuv+2/NCkfph6a8Iwj3Mhvt/PbGb/pBE+QBbEdCw0sFwB8DVJXPp5N+YRdYboA4A735K+qHwnq0l2ohzlDeUQbPedMugNZ7FyGT86iazwwv55zAAAAAElFTkSuQmCC%5D%5D%3E%3C/image%3E%0A%20%20%3Cmode%3E2%3C/mode%3E%0A%20%20%3Cinitcode%3E%3C%21%5BCDATA%5Bif%20%28self.parentNode%20%26%26%20/%5Ewrapper-/.test%28self.parentNode.id%29%29%0A%09return%3B%0A%0Avar%20%24%20%3D%20this.ToolbarsToggler%20%3D%20%7B%0A%09init%3A%20function%28aToggle%29%20%7B%0A%09%09if%20%28%21%28%22Services%22%20in%20window%29%29%0A%09%09%09Cu.import%28%22resource%3A//gre/modules/Services.jsm%22%29%3B%0A%0A%09%09if%20%28%21%28%24._UID%20in%20window%29%29%20%7B%0A%09%09%09window%5B%24._UID%5D%20%3D%20%7B%0A%09%09%09%09CustomizableUI%3A%20false%2C%0A%09%09%09%7D%3B%0A%09%09%7D%0A%0A%09%09%24.initPrefs%28%29%3B%0A%0A%09%09self.onmousedown%20%3D%20self.oncontextmenu%20%3D%20function%28aE%29%20%7B%0A%09%09%09if%20%28%24.accel%28aE%29%29%0A%09%09%09%09aE.preventDefault%28%29%3B%0A%09%09%09aE.stopPropagation%28%29%3B%0A%09%09%7D%3B%0A%09%09self.onclick%20%3D%20function%28aE%29%20%7B%0A%09%09%09if%20%28aE.button%20%21%3D%3D%202%29%0A%09%09%09%09aE.preventDefault%28%29%3B%0A%0A%09%09%09if%20%28aE.button%20%3D%3D%3D%200%20%26%26%20%21aE.shiftKey%20%26%26%20%21%24.accel%28aE%29%20%26%26%20%21aE.altKey%29%20%7B%0A%09%09%09%09%24.handleToolbars%28%22toggle%22%29%3B%0A%09%09%09%7D%20else%20if%20%28aE.button%20%3D%3D%3D%200%20%26%26%20aE.shiftKey%20%26%26%20%24.accel%28aE%29%20%26%26%20%21aE.altKey%29%20%7B%0A%09%09%09%09%24.handleToolbars%28%22show%22%29%3B%0A%09%09%09%7D%20else%20if%20%28aE.button%20%3D%3D%3D%200%20%26%26%20%21aE.shiftKey%20%26%26%20%24.accel%28aE%29%20%26%26%20aE.altKey%29%20%7B%0A%09%09%09%09%24.handleToolbars%28%22hide%22%29%3B%0A%09%09%09%7D%20else%20if%20%28aE.button%20%3D%3D%3D%200%20%26%26%20%21aE.shiftKey%20%26%26%20%24.accel%28aE%29%20%26%26%20%21aE.altKey%20%7C%7C%0A%09%09%09%09aE.button%20%3D%3D%3D%201%20%26%26%20%21aE.shiftKey%20%26%26%20%21%24.accel%28aE%29%20%26%26%20%21aE.altKey%29%20%7B%0A%09%09%09%09%24.openOptions%28%29%3B%0A%09%09%09%7D%20else%20if%20%28aE.button%20%3D%3D%3D%202%20%26%26%20%21aE.shiftKey%20%26%26%20%24.accel%28aE%29%20%26%26%20%21aE.altKey%29%20%7B%0A%09%09%09%09aE.preventDefault%28%29%3B%0A%09%09%09%09%24.chooseToolbars%28%29%3B%0A%09%09%09%7D%0A%09%09%09aE.stopPropagation%28%29%3B%0A%09%09%7D%3B%0A%0A%09%09self.tooltipText%20%3D%20self.name%20+%20%22%20-%20ID%23%3A%20%22%20+%20self.id.slice%2820%29%20+%20%22%5Cn%5Cn%22%20+%0A%09%09%09%22%uD835%uDDDF%uD835%uDDF2%uD835%uDDF3%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%3A%20Toggle%20Toolbars%5Cn%22%20+%0A%09%09%09%24.accel%28%29%20+%20%22%20+%20%uD835%uDDE6%uD835%uDDF5%uD835%uDDF6%uD835%uDDF3%uD835%uDE01%20+%20%uD835%uDDDF%uD835%uDDF2%uD835%uDDF3%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%3A%20Force%20show%20toolbars%5Cn%22%20+%0A%09%09%09%24.accel%28%29%20+%20%22%20+%20%uD835%uDDD4%uD835%uDDF9%uD835%uDE01%20+%20%uD835%uDDDF%uD835%uDDF2%uD835%uDDF3%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%3A%20Force%20hide%20toolbars%5Cn%22%20+%0A%09%09%09%24.accel%28%29%20+%20%22%20+%20%uD835%uDDE5%uD835%uDDF6%uD835%uDDF4%uD835%uDDF5%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%3A%20Choose%20toolbars%20to%20control%5Cn%22%20+%0A%09%09%09%22%uD835%uDDE0%uD835%uDDF6%uD835%uDDF1%uD835%uDDF1%uD835%uDDF9%uD835%uDDF2%20%uD835%uDDFC%uD835%uDDFF%20%22%20+%20%24.accel%28%29%20+%20%22%20+%20%uD835%uDDDF%uD835%uDDF2%uD835%uDDF3%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%3A%20Open%20Options%5Cn%5Cn%22%20+%0A%09%09%09%22%uD835%uDDE5%uD835%uDDF2%uD835%uDDEE%uD835%uDDF1%20%uD835%uDE01%uD835%uDDF5%uD835%uDDF6%uD835%uDE00%20%uD835%uDDEF%uD835%uDE02%uD835%uDE01%uD835%uDE01%uD835%uDDFC%uD835%uDDFB%20%uD835%uDDF5%uD835%uDDF2%uD835%uDDF9%uD835%uDDFD%20%uD835%uDDF3%uD835%uDDFC%uD835%uDDFF%20%uD835%uDE03%uD835%uDDF2%uD835%uDDFF%uD835%uDE06%20%uD835%uDDF6%uD835%uDDFA%uD835%uDDFD%uD835%uDDFC%uD835%uDDFF%uD835%uDE01%uD835%uDDEE%uD835%uDDFB%uD835%uDE01%20%uD835%uDE02%uD835%uDE00%uD835%uDDEE%uD835%uDDF4%uD835%uDDF2%20%uD835%uDDFB%uD835%uDDFC%uD835%uDE01%uD835%uDDF2%uD835%uDE00.%5Cn%22%20+%0A%09%09%09%22%uD835%uDDE5%uD835%uDDF6%uD835%uDDF4%uD835%uDDF5%uD835%uDE01%20%uD835%uDDF0%uD835%uDDF9%uD835%uDDF6%uD835%uDDF0%uD835%uDDF8%20%uD835%uDDFC%uD835%uDDFB%20%uD835%uDDEF%uD835%uDE02%uD835%uDE01%uD835%uDE01%uD835%uDDFC%uD835%uDDFB%2C%20%5C%22%uD835%uDDD5%uD835%uDE02%uD835%uDE01%uD835%uDE01%uD835%uDDFC%uD835%uDDFB%20%uD835%uDDDB%uD835%uDDF2%uD835%uDDF9%uD835%uDDFD%5C%22%20%uD835%uDDF6%uD835%uDE01%uD835%uDDF2%uD835%uDDFA.%22%3B%0A%0A%09%09if%20%28%24.gPref%28%22pHideButtonImage%22%29%29%20%7B%0A%09%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09%09let%20img%20%3D%20document.getAnonymousElementByAttribute%28self%2C%20%22class%22%2C%20%22toolbarbutton-icon%22%29%3B%0A%09%09%09%09img%20%26%26%20%28img.collapsed%20%3D%20true%29%3B%0A%09%09%09%09self.setAttribute%28%22class%22%2C%20%22%22%29%3B%20//%20Remove%20classes%20from%20button%20to%20avoid%20getting%20stylized.%0A%09%09%09%09self.setAttribute%28%22style%22%2C%20%22padding%3A%200%20%21important%3B%20%20margin-right%3A%200%20%21important%3B%22%29%3B%0A%09%09%09%7D%2C%20500%29%3B%0A%09%09%7D%0A%09%09if%20%28%24.gPref%28%22pShowToolbarsOnMouseOver%22%29%29%20%7B%0A%09%09%09%24.handleToolbars%28%22hide%22%29%3B%0A%09%09%09%24.handleSelfListeners%28%29%3B%0A%09%09%7D%0A%09%09%24.createElements%28%29%3B%0A%09%09%24.handlePrefObserver%28%29%3B%0A%0A%09%09if%20%28%22CustomizableUI%22%20in%20window%29%20%7B%0A%09%09%09if%20%28%21window%5B%24._UID%5D%5B%22CustomizableUI%22%5D%29%20%7B%0A%09%09%09%09window%5B%24._UID%5D%5B%22CustomizableUI%22%5D%20%3D%20true%3B%0A%09%09%09%09CustomizableUI.addListener%28%7B%0A%09%09%09%09%09onCustomizeEnd%3A%20function%28aWindow%29%20%7B%0A%09%09%09%09%09%09var%20thisBtn%20%3D%20aWindow.document.getElementById%28self.id%29%3B%0A%09%09%09%09%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09%09%09%09%09aWindow%5B%24._UID%5D%5B%22CustomizableUI%22%5D%20%26%26%20thisBtn.ToolbarsToggler.softSelfDestroy%28%29%3B%0A%09%09%09%09%09%09%7D%2C%20Math.floor%28Math.random%28%29%20*%20%281%20+%202000%20-%20200%29%29%20+%20200%29%3B%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%29%3B%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09%09addDestructor%28function%28aReason%29%20%7B%0A%09%09%09if%20%28aReason%20%3D%3D%3D%20%22delete%22%20%7C%7C%20aReason%20%3D%3D%3D%20%22update%22%29%20%7B%0A%09%09%09%09let%20selfEls%20%3D%20document.getElementsByAttribute%28%22cb_id%22%2C%20%24._UID%29%3B%0A%09%09%09%09Array.prototype.slice.call%28selfEls%29.forEach%28function%28aEl%29%20%7B%20//%20Delete%20all%20elements%20created%20by%20this%20button.%0A%09%09%09%09%09aEl%20%26%26%20aEl.parentNode.removeChild%28aEl%29%3B%0A%09%09%09%09%7D%29%3B%0A%09%09%09%09%24.handleGlobalListener%28true%29%3B%0A%09%09%09%09%24.handlePrefObserver%28true%29%3B%0A%09%09%09%09%24.handleSelfListeners%28true%29%3B%0A%09%09%09%7D%0A%09%09%09if%20%28aReason%20%3D%3D%3D%20%22delete%22%29%20%7B%0A%09%09%09%09%28Services.prefs.getBranch%28%24.Branch%29%29.deleteBranch%28%22%22%29%3B%0A%09%09%09%09Services.prefs.savePrefFile%28null%29%3B%0A%09%09%09%09delete%20window%5B%24._UID%5D%3B%0A%09%09%09%7D%0A%09%09%7D%29%3B%0A%09%7D%2C%0A%0A%09hotkeyPressed%3A%20function%28%29%20%7B%0A%09%09%24.handleToolbars%28%22toggle%22%29%3B%0A%09%7D%2C%0A%0A%09createElements%3A%20function%28%29%20%7B%0A%09%09let%20popSet%20%3D%20document.getElementById%28%22mainPopupSet%22%29%3B%0A%09%09let%20tBM%20%3D%20document.getElementById%28%24._UID%20+%20%22_toolbar_selection_panel%22%29%3B%0A%09%09if%20%28popSet%20%26%26%20%21tBM%29%20%7B%0A%09%09%09popSet.appendChild%28%24.%24CNS%28%22panel%22%2C%20%7B%0A%09%09%09%09id%3A%20%24._UID%20+%20%22_toolbar_selection_panel%22%2C%0A%09%09%09%09cb_id%3A%20%24._UID%2C%0A%09%09%09%09orient%3A%20%22vertical%22%2C%0A%09%09%09%09flex%3A%201%2C%0A%09%09%09%09close%3A%20true%2C%0A%09%09%09%09titlebar%3A%20%22normal%22%2C%0A%09%09%09%09level%3A%20%22top%22%2C%0A%09%09%09%09noautohide%3A%20true%2C%0A%09%09%09%09oncommand%3A%20%22event.stopPropagation%28%29%3B%22%2C%0A%09%09%09%09onclick%3A%20%22event.stopPropagation%28%29%3B%22%2C%0A%09%09%09%09onpopuphidden%3A%20%22document.getElementById%28%27%22%20+%20self.id%20+%0A%09%09%09%09%09%22%27%29.ToolbarsToggler.saveToolbarIDs%28this%29%3Bevent.stopPropagation%28%29%3B%22%2C%0A%09%09%09%09onpopupshowing%3A%20%22document.getElementById%28%27%22%20+%20self.id%20+%0A%09%09%09%09%09%22%27%29.ToolbarsToggler.populateToolbarSelectionPanel%28this%29%3Bevent.stopPropagation%28%29%3B%22%2C%0A%09%09%09%09consumeoutsideclicks%3A%20false%2C%0A%09%09%09%7D%29%29%3B%0A%09%09%7D%0A%09%7D%2C%0A%0A%09populateToolbarSelectionPanel%3A%20function%28aN%29%20%7B%0A%09%09aN.textContent%20%3D%20%22%22%3B%0A%09%09aN.label%20%3D%20%22Available%20toolbars%22%3B%0A%0A%09%09aN.appendChild%28%24.%24CNS%28%22description%22%2C%20%7B%0A%09%09%09value%3A%20%22Check%20the%20toolbars%20that%20you%20wish%20to%20control.%22%2C%0A%09%09%09style%3A%20%22font-weight%3Abold%3B%22%0A%09%09%7D%29%29%3B%0A%0A%09%09let%20controlledTBars%20%3D%20%24.gPref%28%22pToolbarIDs%22%29.split%28%22%2C%22%29.filter%28function%28aVal%29%20%7B%0A%09%09%09if%20%28aVal%20%21%3D%3D%20%22%22%29%0A%09%09%09%09return%20true%3B%0A%09%09%7D%29%3B%0A%09%09var%20grid%20%3D%20aN.appendChild%28%24.%24CNS%28%22grid%22%29%29%3B%0A%09%09var%20cols%20%3D%20grid.appendChild%28%24.%24CNS%28%22columns%22%29%29%3B%0A%09%09cols.appendChild%28%24.%24CNS%28%22column%22%2C%20%7B%0A%09%09%09flex%3A%201%0A%09%09%7D%29%29%3B%0A%09%09cols.appendChild%28%24.%24CNS%28%22column%22%2C%20%7B%0A%09%09%09flex%3A%201%0A%09%09%7D%29%29%3B%0A%09%09cols.appendChild%28%24.%24CNS%28%22column%22%2C%20%7B%0A%09%09%09flex%3A%201%0A%09%09%7D%29%29%3B%0A%09%09cols.appendChild%28%24.%24CNS%28%22column%22%2C%20%7B%0A%09%09%09flex%3A%201%0A%09%09%7D%29%29%3B%0A%09%09var%20rows%20%3D%20grid.appendChild%28%24.%24CNS%28%22rows%22%29%29%3B%0A%09%09Array.prototype.slice.call%28%24.getTogglableToolbars%28%29%29.forEach%28function%28aEl%29%20%7B%0A%09%09%09let%20row%20%3D%20rows.appendChild%28%24.%24CNS%28%22row%22%2C%20%7B%0A%09%09%09%09align%3A%20%22center%22%0A%09%09%09%7D%29%29%3B%0A%09%09%09row.appendChild%28%24.%24CNS%28%22checkbox%22%2C%20%7B%0A%09%09%09%09checked%3A%20controlledTBars.indexOf%28aEl.getAttribute%28%22id%22%29%29%20%21%3D%3D%20-1%2C%0A%09%09%09%09%22data-toolbar-id%22%3A%20aEl.getAttribute%28%22id%22%29%2C%0A%09%09%09%09label%3A%20aEl.getAttribute%28%22toolbarname%22%29%2C%0A%09%09%09%09style%3A%20%22font-weight%3Abold%3B%22%0A%09%09%09%7D%29%29%3B%0A%09%09%09row.appendChild%28%24.%24CNS%28%22label%22%2C%20%7B%0A%09%09%09%09value%3A%20%22ID%3A%22%2C%0A%09%09%09%09style%3A%20%22font-weight%3Abold%3B%22%0A%09%09%09%7D%29%29%3B%0A%09%09%09row.appendChild%28%24.%24CNS%28%22textbox%22%2C%20%7B%0A%09%09%09%09value%3A%20aEl.getAttribute%28%22id%22%29%2C%0A%09%09%09%09readonly%3A%20true%2C%0A%09%09%09%7D%29%29%3B%0A%09%09%7D%29%3B%0A%09%09aN.appendChild%28%24.%24CNS%28%22description%22%2C%20%7B%0A%09%09%09value%3A%20%22Changes%20will%20be%20saved%20when%20this%20panel%20is%20closed.%22%2C%0A%09%09%09style%3A%20%22font-weight%3Abold%3B%22%0A%09%09%7D%29%29%3B%0A%09%7D%2C%0A%0A%09saveToolbarIDs%3A%20function%28aNode%29%20%7B%0A%09%09let%20cBoxes%20%3D%20aNode.getElementsByTagName%28%22checkbox%22%29%3B%0A%09%09let%20newControlledTBarIDs%20%3D%20%5B%5D%3B%0A%09%09try%20%7B%0A%09%09%09let%20checkedCBoxes%20%3D%20Array.prototype.slice.call%28cBoxes%29.filter%28function%28aCBox%29%20%7B%0A%09%09%09%09if%20%28aCBox.checked%29%0A%09%09%09%09%09return%20true%3B%0A%09%09%09%7D%29%3B%0A%09%09%09checkedCBoxes.forEach%28function%28aCB%29%20%7B%0A%09%09%09%09newControlledTBarIDs.push%28aCB.getAttribute%28%22data-toolbar-id%22%29%29%3B%0A%09%09%09%7D%29%3B%0A%09%09%7D%20finally%20%7B%0A%09%09%09%24.sPref%28%22pToolbarIDs%22%2C%20newControlledTBarIDs.join%28%22%2C%22%29%29%3B%0A%09%09%7D%0A%09%7D%2C%0A%0A%09chooseToolbars%3A%20function%28%29%20%7B%0A%09%09let%20p%20%3D%20document.getElementById%28%24._UID%20+%20%22_toolbar_selection_panel%22%29%3B%0A%09%09p%20%26%26%20p.openPopupAtScreen%28%28screen.availWidth%20/%202%29%2C%20%28screen.availHeight%20/%202%29%2C%20false%29%3B%0A%09%7D%2C%0A%0A%09openOptions%3A%20function%28%29%20%7B%0A%09%09var%20url%20%3D%20%22about%3Aconfig%3Ffilter%3D%22%20+%20%24.Branch%3B%0A%09%09if%20%28%24.gPref%28%22zOpenOptionsInTab%22%29%20%26%26%20%28%22gBrowser%22%20in%20window%29%29%20%7B%0A%09%09%09let%20tab%20%3D%20gBrowser.visibleTabs.find%28tab%20%3D%3E%20tab.linkedBrowser.currentURI.spec%20%3D%3D%3D%20url%29%3B%0A%09%09%09gBrowser.selectedTab%20%3D%20tab%20%7C%7C%20gBrowser.addTab%28url%29%3B%0A%09%09%7D%20else%0A%09%09%09toOpenWindowByType%28%22Preferences%3AConfigManager%22%2C%20url%29%3B%0A%09%7D%2C%0A%0A%09onMouseOver%3A%20function%28aE%29%20%7B%0A%09%09aE.preventDefault%28%29%3B%0A%09%09%24.mouseoverAction%20%3D%20function%28%29%20%7B%0A%09%09%09%24.handleToolbars%28%22show%22%29%3B%0A%09%09%7D%3B%0A%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09%24.mouseoverAction%20%26%26%20%24.mouseoverAction%28%29%3B%0A%09%09%09%24.handleGlobalListener%28%29%3B%0A%09%09%7D%2C%20%24.gPref%28%22pShowToolbarsOnMouseOverDelay%22%29%29%3B%0A%09%09aE.stopPropagation%28%29%3B%0A%09%7D%2C%0A%0A%09onMouseOut%3A%20function%28aE%29%20%7B%0A%09%09aE.preventDefault%28%29%3B%0A%09%09%24.mouseoverAction%20%3D%20null%3B%0A%09%09aE.stopPropagation%28%29%3B%0A%09%7D%2C%0A%0A%09handleSelfListeners%3A%20function%28aRem%29%20%7B%0A%09%09self.removeEventListener%28%22mouseover%22%2C%20%24.onMouseOver%2C%20false%29%3B%0A%09%09self.removeEventListener%28%22mouseout%22%2C%20%24.onMouseOut%2C%20false%29%3B%0A%09%09if%20%28aRem%29%0A%09%09%09return%20true%3B%0A%09%09if%20%28%24.gPref%28%22pShowToolbarsOnMouseOver%22%29%29%20%7B%0A%09%09%09self.addEventListener%28%22mouseover%22%2C%20%24.onMouseOver%2C%20false%29%3B%0A%09%09%09self.addEventListener%28%22mouseout%22%2C%20%24.onMouseOut%2C%20false%29%3B%0A%09%09%7D%0A%09%7D%2C%0A%0A%09handleToolbars%3A%20function%28aHandle%29%20%7B%0A%09%09var%20tBarIDs%20%3D%20%24.gPref%28%22pToolbarIDs%22%29.split%28%22%2C%22%29.filter%28function%28aVal%29%20%7B%0A%09%09%09if%20%28aVal%20%21%3D%3D%20%22%22%29%0A%09%09%09%09return%20true%3B%0A%09%09%7D%29%3B%0A%09%09var%20CUI%20%3D%20%22CustomizableUI%22%20in%20window%2C%0A%09%09%09STV%20%3D%20%22setToolbarVisibility%22%20in%20window%3B%0A%09%09for%20%28var%20i%20%3D%20tBarIDs.length%20-%201%3B%20i%20%3E%3D%200%3B%20i--%29%20%7B%0A%09%09%09let%20tBar%20%3D%20document.getElementById%28tBarIDs%5Bi%5D%29%3B%0A%09%09%09if%20%28tBar%29%20%7B%0A%09%09%09%09switch%20%28aHandle%29%20%7B%0A%09%09%09%09%09case%20%22show%22%3A%0A%09%09%09%09%09%09if%20%28CUI%29%0A%09%09%09%09%09%09%09CustomizableUI.setToolbarVisibility%28tBar.id%2C%20true%29%3B%0A%09%09%09%09%09%09else%20if%20%28STV%29%0A%09%09%09%09%09%09%09window.setToolbarVisibility%28tBar%2C%20true%29%3B%0A%09%09%09%09%09%09else%0A%09%09%09%09%09%09%09tBar.setAttribute%28%22hidden%22%2C%20false%29%3B%0A%09%09%09%09%09%09break%3B%0A%09%09%09%09%09case%20%22hide%22%3A%0A%09%09%09%09%09%09if%20%28CUI%29%0A%09%09%09%09%09%09%09CustomizableUI.setToolbarVisibility%28tBar.id%2C%20false%29%3B%0A%09%09%09%09%09%09else%20if%20%28STV%29%0A%09%09%09%09%09%09%09window.setToolbarVisibility%28tBar%2C%20false%29%3B%0A%09%09%09%09%09%09else%0A%09%09%09%09%09%09%09tBar.setAttribute%28%22hidden%22%2C%20true%29%3B%0A%09%09%09%09%09%09break%3B%0A%09%09%09%09%09case%20%22toggle%22%3A%0A%09%09%09%09%09%09if%20%28CUI%29%0A%09%09%09%09%09%09%09CustomizableUI.setToolbarVisibility%28tBar.id%2C%20tBar.collapsed%29%3B%0A%09%09%09%09%09%09else%20if%20%28STV%29%0A%09%09%09%09%09%09%09window.setToolbarVisibility%28tBar%2C%0A%09%09%09%09%09%09%09%09tBar.getAttribute%28%22collapsed%22%29%20%3D%3D%3D%20%22true%22%20%3F%20true%20%3A%20false%29%3B%0A%09%09%09%09%09%09else%0A%09%09%09%09%09%09%09tBar.setAttribute%28%22hidden%22%2C%0A%09%09%09%09%09%09%09%09tBar.getAttribute%28%22hidden%22%29%20%3D%3D%3D%20%22true%22%20%3F%20false%20%3A%20true%29%3B%0A%09%09%09%09%09%09break%3B%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%2C%0A%0A%09globalListener%3A%20function%28aE%29%20%7B%0A%09%09var%20isChild%20%3D%20%24.isChild%28aE.target%29%2C%0A%09%09%09keepIpOpen%20%3D%20false%3B%0A%09%09if%20%28%28aE.button%20%3D%3D%3D%202%20%7C%7C%20aE.button%20%3D%3D%3D%201%29%20%26%26%20isChild%29%0A%09%09%09return%3B%0A%09%09if%20%28%21%21aE.target.childNodes%29%20%7B%0A%09%09%09var%20cNodes%20%3D%20aE.target.childNodes.length%2C%0A%09%09%09%09i%20%3D%200%3B%0A%09%09%09for%20%28%3B%20i%20%3C%20cNodes%3B%20i++%29%20%7B%0A%09%09%09%09let%20nodeName%20%3D%20aE.target.childNodes%5Bi%5D.nodeName%3B%0A%09%09%09%09if%20%28nodeName%20%3D%3D%3D%20%22menupopup%22%20%7C%7C%20nodeName%20%3D%3D%3D%20%22popup%22%20%7C%7C%20nodeName%20%3D%3D%3D%20%22panel%22%29%0A%09%09%09%09%09keepIpOpen%20%3D%20true%3B%0A%09%09%09%09break%3B%0A%09%09%09%7D%0A%09%09%7D%0A%09%09if%20%28%21isChild%29%0A%09%09%09keepIpOpen%20%3D%20false%3B%0A%09%09if%20%28keepIpOpen%29%0A%09%09%09return%3B%0A%09%09%24.handleToolbars%28%22hide%22%29%3B%0A%09%09%24.handleGlobalListener%28true%29%3B%0A%09%7D%2C%0A%0A%09handleGlobalListener%3A%20function%28aRem%29%20%7B%0A%09%09window.removeEventListener%28%22mouseup%22%2C%20%24.globalListener%2C%20false%29%3B%0A%09%09if%20%28aRem%29%0A%09%09%09return%3B%0A%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09window.addEventListener%28%22mouseup%22%2C%20%24.globalListener%2C%20false%29%3B%0A%09%09%7D%2C%2010%29%3B%0A%09%7D%2C%0A%0A%09isChild%3A%20function%28aTargetNode%29%20%7B%0A%09%09if%20%28%21aTargetNode%29%0A%09%09%09return%20false%3B%0A%09%09var%20tBarIDs%20%3D%20%24.gPref%28%22pToolbarIDs%22%29.split%28%22%2C%22%29.filter%28function%28aVal%29%20%7B%0A%09%09%09if%20%28aVal%20%21%3D%3D%20%22%22%29%0A%09%09%09%09return%20true%3B%0A%09%09%7D%29%3B%0A%09%09for%20%28var%20i%20%3D%20tBarIDs.length%20-%201%3B%20i%20%3E%3D%200%3B%20i--%29%20%7B%0A%09%09%09if%20%28document.getElementById%28tBarIDs%5Bi%5D%29.contains%28aTargetNode%29%29%0A%09%09%09%09return%20true%3B%0A%09%09%7D%0A%09%09return%20false%3B%0A%09%7D%2C%0A%0A%09handlePrefObserver%3A%20function%28aRem%29%20%7B%0A%09%09var%20prefs%20%3D%20%24.DefPrefs%3B%0A%09%09for%20%28let%20key%20in%20prefs%29%20%7B%0A%09%09%09let%20pref%20%3D%20%24.Branch%20+%20key%3B%0A%09%09%09if%20%28prefs.hasOwnProperty%28key%29%29%20%7B%0A%09%09%09%09if%20%28aRem%29%0A%09%09%09%09%09Services.prefs.removeObserver%28pref%2C%20%24.prefObserver%2C%20false%29%3B%0A%09%09%09%09else%0A%09%09%09%09%09Services.prefs.addObserver%28pref%2C%20%24.prefObserver%2C%20false%29%3B%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%2C%0A%0A%09prefObserver%3A%20%7B%0A%09%09observe%3A%20function%28aSubject%2C%20aTopic%2C%20aPStr%29%20%7B%0A%09%09%09if%20%28aTopic%20%3D%3D%3D%20%22nsPref%3Achanged%22%29%20%7B%0A%09%09%09%09switch%20%28aPStr.slice%28%24.Branch.length%29%29%20%7B%0A%09%09%09%09%09case%20%22pHideButtonImage%22%3A%0A%09%09%09%09%09%09%24.hardSelfDestroy%28%29%3B%0A%09%09%09%09%09%09break%3B%0A%09%09%09%09%09case%20%22pShowToolbarsOnMouseOver%22%3A%0A%09%09%09%09%09%09%24.handleToolbars%28%22hide%22%29%3B%0A%09%09%09%09%09%09%24.handleSelfListeners%28%29%3B%0A%09%09%09%09%09%09break%3B%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%2C%0A%0A%09/**%0A%09%20*%20%5BhardSelfDestroy%20description%5D%0A%09%20*%20The%20self.destroy%20+%20self.init%20combination%20is%20not%20gonna%20cut%20it%20here%20when%20showing/hiding%20button%20image.%0A%09%20*/%0A%09hardSelfDestroy%3A%20function%28%29%20%7B%0A%09%09var%20initCode%20%3D%20self.cbInitCode%3B%0A%09%09var%20link%20%3D%20custombuttons.makeButtonLink%28%22edit%22%2C%20self.id%29%3B%0A%09%09var%20cbService%20%3D%20custombuttons.cbService%3B%0A%09%09var%20param%20%3D%20cbService.getButtonParameters%28link%29%3B%0A%09%09param%20%3D%20param.wrappedJSObject%20%7C%7C%20param%3B%0A%09%09param.initCode%20%3D%20initCode%3B%0A%09%09cbService.installButton%28param%29%3B%0A%09%7D%2C%0A%0A%09softSelfDestroy%3A%20function%28%29%20%7B%0A%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09self.destroy%28%22update%22%29%3B%0A%09%09%09setTimeout%28function%28%29%20%7B%0A%09%09%09%09self.init%28%29%3B%0A%09%09%09%7D%2C%20100%29%3B%0A%09%09%7D%2C%20100%29%3B%0A%09%7D%2C%0A%0A%09getTogglableToolbars%3A%20function%28%29%20%7B%0A%09%09let%20toolbarNodes%3B%0A%09%09if%20%28%22gNavToolbox%22%20in%20window%29%20%7B%0A%09%09%09toolbarNodes%20%3D%20Array.slice%28gNavToolbox.childNodes%29%3B%0A%09%09%09toolbarNodes%20%3D%20toolbarNodes.concat%28gNavToolbox.externalToolbars%29%3B%0A%09%09%7D%20else%0A%09%09%09toolbarNodes%20%3D%20Array.slice%28document.getElementsByTagName%28%22toolbar%22%29%29%3B%0A%0A%09%09toolbarNodes%20%3D%20toolbarNodes.filter%28node%20%3D%3E%20node.getAttribute%28%22toolbarname%22%29%29%3B%0A%09%09return%20toolbarNodes%3B%0A%0A%09%7D%2C%0A%0A%09%24CNS%3A%20function%28aElName%2C%20aAttrs%2C%20aNameSpace%29%20%7B%20//%20Creates%20elements%0A%09%09var%20el%20%3D%20aNameSpace%20%3F%0A%09%09%09document.createElementNS%28aNameSpace%2C%20aElName%29%20%3A%0A%09%09%09document.createElement%28aElName%29%3B%0A%09%09if%20%28aAttrs%29%0A%09%09%09Object.keys%28aAttrs%29.forEach%28function%28n%29%20%7B%0A%09%09%09%09if%20%28aAttrs%5Bn%5D%20%21%3D%3D%20%22%22%29%0A%09%09%09%09%09el.setAttribute%28n%2C%20aAttrs%5Bn%5D%29%3B%0A%09%09%09%7D%29%3B%0A%09%09return%20el%3B%0A%09%7D%2C%0A%09accel%3A%20function%28aE%29%20%7B%0A%09%09if%20%28aE%29%0A%09%09%09return%20%24.isOSX%20%3F%20aE.metaKey%20%3A%20aE.ctrlKey%3B%0A%09%09return%20%24.isOSX%20%3F%20%22%uD835%uDDD6%uD835%uDDFC%uD835%uDDFA%uD835%uDDFA%uD835%uDDEE%uD835%uDDFB%uD835%uDDF1%22%20%3A%20%22%uD835%uDDD6%uD835%uDDFC%uD835%uDDFB%uD835%uDE01%uD835%uDDFF%uD835%uDDFC%uD835%uDDF9%22%3B%0A%09%7D%2C%0A%09isOSX%3A%20Services.appinfo.OS.toLowerCase%28%29.startsWith%28%22darwin%22%29%2C%0A%09mouseoverAction%3A%20null%2C%0A%09_UID%3A%20%22__auto_hide_toolbars_%22%20+%20self.id.slice%2820%29%2C%0A%0A%7D%3B%0A%0Athis.ToolbarsToggler.gPref%20%3D%20function%28aKey%29%20%7B%0A%09let%20branch%20%3D%20Services.prefs.getBranch%28self.ToolbarsToggler.Branch%29%3B%0A%09switch%20%28typeof%20self.ToolbarsToggler.DefPrefs%5BaKey%5D%29%20%7B%0A%09%09case%20%22boolean%22%3A%0A%09%09%09return%20branch.getBoolPref%28aKey%29%3B%0A%09%09case%20%22number%22%3A%0A%09%09%09return%20branch.getIntPref%28aKey%29%3B%0A%09%09case%20%22string%22%3A%0A%09%09%09return%20branch.getComplexValue%28aKey%2C%20Ci.nsISupportsString%29.data%3B%0A%09%7D%0A%09return%20null%3B%0A%7D%3B%0A%0Athis.ToolbarsToggler.sPref%20%3D%20function%28aKey%2C%20aVal%29%20%7B%0A%09let%20branch%20%3D%20Services.prefs.getBranch%28self.ToolbarsToggler.Branch%29%3B%0A%09switch%20%28typeof%20aVal%29%20%7B%0A%09%09case%20%22boolean%22%3A%0A%09%09%09branch.setBoolPref%28aKey%2C%20aVal%29%3B%0A%09%09%09break%3B%0A%09%09case%20%22number%22%3A%0A%09%09%09branch.setIntPref%28aKey%2C%20aVal%29%3B%0A%09%09%09break%3B%0A%09%09case%20%22string%22%3A%0A%09%09%09let%20str%20%3D%20Cc%5B%22@mozilla.org/supports-string%3B1%22%5D.createInstance%28Ci.nsISupportsString%29%3B%0A%09%09%09str.data%20%3D%20aVal%3B%0A%09%09%09branch.setComplexValue%28%28aKey%29%2C%20Ci.nsISupportsString%2C%20str%29%3B%0A%09%09%09break%3B%0A%09%7D%0A%7D%3B%0A%0Athis.ToolbarsToggler.initPrefs%20%3D%20function%28%29%20%7B%0A%09let%20branch%20%3D%20Services.prefs.getDefaultBranch%28self.ToolbarsToggler.Branch%29%2C%0A%09%09defaults%20%3D%20self.ToolbarsToggler.DefPrefs%3B%0A%09for%20%28let%20key%20in%20defaults%29%20%7B%0A%09%09if%20%28defaults.hasOwnProperty%28key%29%29%20%7B%0A%09%09%09let%20val%20%3D%20defaults%5Bkey%5D%3B%0A%09%09%09switch%20%28typeof%20val%29%20%7B%0A%09%09%09%09case%20%22boolean%22%3A%0A%09%09%09%09%09branch.setBoolPref%28key%2C%20val%29%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%09case%20%22number%22%3A%0A%09%09%09%09%09branch.setIntPref%28key%2C%20val%29%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%09case%20%22string%22%3A%0A%09%09%09%09%09let%20str%20%3D%20Cc%5B%22@mozilla.org/supports-string%3B1%22%5D.createInstance%28Ci.nsISupportsString%29%3B%0A%09%09%09%09%09str.data%20%3D%20val%3B%0A%09%09%09%09%09branch.setComplexValue%28%28key%29%2C%0A%09%09%09%09%09%09Ci.nsISupportsString%2C%20str%29%3B%0A%09%09%09%09%09break%3B%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%7D%3B%0A%0Athis.ToolbarsToggler.Branch%20%3D%20%22CB.ToolbarsToggler.Id%22%20+%20self.id.slice%2820%29%20+%20%22.%22%3B%0A%0Athis.ToolbarsToggler.DefPrefs%20%3D%20%7B%0A%09pShowToolbarsOnMouseOver%3A%20false%2C%0A%09pShowToolbarsOnMouseOverDelay%3A%20200%2C%0A%09pToolbarIDs%3A%20%22PersonalToolbar%22%2C%0A%09pHideButtonImage%3A%20false%2C%0A%7D%3B%0A%0Athis.ToolbarsToggler.init%28%29%3B%5D%5D%3E%3C/initcode%3E%0A%20%20%3Ccode%3E%3C%21%5BCDATA%5Bif%28%21event.target%20%26%26%20%21this.disabled%29%0A%09this.AutoHideToolbars.hotkeyPressed%28%29%3B%0A%5D%5D%3E%3C/code%3E%0A%20%20%3Caccelkey%3E%3C%21%5BCDATA%5BCtrl+Shift+V%5D%5D%3E%3C/accelkey%3E%0A%20%20%3Chelp%3E%3C%21%5BCDATA%5B%5D%5D%3E%3C/help%3E%0A%20%20%3Cattributes/%3E%0A%3C/custombutton%3E" rel="nofollow" title="Install Toolbars Toggler">
				<![CDATA[Install this button]]>
			</html:a>
		</html:div>
		<html:a id="about" href="https://addons.mozilla.org/addon/custom-buttons/">
			<![CDATA[About CustomButtons]]>
		</html:a>
		<html:div id="credits">
			<html:a href="http://custombuttons.sourceforge.net/forum/viewtopic.php?t=3599">
				<![CDATA[XML created with]]>
				<html:br/>
				<![CDATA[CB Context Menu Extended]]>
			</html:a>
		</html:div>
	</html:div>
</html:body>
  <name>Toolbars Toggler</name>
  <image><![CDATA[data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABC0lEQVQ4jZXTMUpDQRSF4Y8IKu5BEcSFhFhZqGAKiRjRMq0opLAQRLC0ElyBRdSANlmBmFWIuAWJ+hJj8W4kKDrPAxcezDv/nJl7h1wVPOAdw0T10cWSMXMfLdRQTVQN1+GpiJ1b0prBZZj30A6vN2wWAKxhJ75vsR1H9ojjAoB5dNCIJKfhdYBepJhKQOawgl28Yh9KOMNAugOjGoSnNE6fDXqqC6uR5IcW44eNRFWxMG6cwMU/4g/xgfPwOsQLtrAuv+2/NCkfph6a8Iwj3Mhvt/PbGb/pBE+QBbEdCw0sFwB8DVJXPp5N+YRdYboA4A735K+qHwnq0l2ohzlDeUQbPedMugNZ7FyGT86iazwwv55zAAAAAElFTkSuQmCC]]></image>
  <mode>2</mode>
  <initcode><![CDATA[if (self.parentNode && /^wrapper-/.test(self.parentNode.id))
	return;

var $ = this.ToolbarsToggler = {
	init: function(aToggle) {
		if (!("Services" in window))
			Cu.import("resource://gre/modules/Services.jsm");

		if (!($._UID in window)) {
			window[$._UID] = {
				CustomizableUI: false,
			};
		}

		$.initPrefs();

		self.onmousedown = self.oncontextmenu = function(aE) {
			if ($.accel(aE))
				aE.preventDefault();
			aE.stopPropagation();
		};
		self.onclick = function(aE) {
			if (aE.button !== 2)
				aE.preventDefault();

			if (aE.button === 0 && !aE.shiftKey && !$.accel(aE) && !aE.altKey) {
				$.handleToolbars("toggle");
			} else if (aE.button === 0 && aE.shiftKey && $.accel(aE) && !aE.altKey) {
				$.handleToolbars("show");
			} else if (aE.button === 0 && !aE.shiftKey && $.accel(aE) && aE.altKey) {
				$.handleToolbars("hide");
			} else if (aE.button === 0 && !aE.shiftKey && $.accel(aE) && !aE.altKey ||
				aE.button === 1 && !aE.shiftKey && !$.accel(aE) && !aE.altKey) {
				$.openOptions();
			} else if (aE.button === 2 && !aE.shiftKey && $.accel(aE) && !aE.altKey) {
				aE.preventDefault();
				$.chooseToolbars();
			}
			aE.stopPropagation();
		};

		self.tooltipText = self.name + " - ID#: " + self.id.slice(20) + "\n\n" +
			"𝗟𝗲𝗳𝘁 𝗰𝗹𝗶𝗰𝗸: Toggle Toolbars\n" +
			$.accel() + " + 𝗦𝗵𝗶𝗳𝘁 + 𝗟𝗲𝗳𝘁 𝗰𝗹𝗶𝗰𝗸: Force show toolbars\n" +
			$.accel() + " + 𝗔𝗹𝘁 + 𝗟𝗲𝗳𝘁 𝗰𝗹𝗶𝗰𝗸: Force hide toolbars\n" +
			$.accel() + " + 𝗥𝗶𝗴𝗵𝘁 𝗰𝗹𝗶𝗰𝗸: Choose toolbars to control\n" +
			"𝗠𝗶𝗱𝗱𝗹𝗲 𝗼𝗿 " + $.accel() + " + 𝗟𝗲𝗳𝘁 𝗰𝗹𝗶𝗰𝗸: Open Options\n\n" +
			"𝗥𝗲𝗮𝗱 𝘁𝗵𝗶𝘀 𝗯𝘂𝘁𝘁𝗼𝗻 𝗵𝗲𝗹𝗽 𝗳𝗼𝗿 𝘃𝗲𝗿𝘆 𝗶𝗺𝗽𝗼𝗿𝘁𝗮𝗻𝘁 𝘂𝘀𝗮𝗴𝗲 𝗻𝗼𝘁𝗲𝘀.\n" +
			"𝗥𝗶𝗴𝗵𝘁 𝗰𝗹𝗶𝗰𝗸 𝗼𝗻 𝗯𝘂𝘁𝘁𝗼𝗻, \"𝗕𝘂𝘁𝘁𝗼𝗻 𝗛𝗲𝗹𝗽\" 𝗶𝘁𝗲𝗺.";

		if ($.gPref("pHideButtonImage")) {
			setTimeout(function() {
				let img = document.getAnonymousElementByAttribute(self, "class", "toolbarbutton-icon");
				img && (img.collapsed = true);
				self.setAttribute("class", ""); // Remove classes from button to avoid getting stylized.
				self.setAttribute("style", "padding: 0 !important;  margin-right: 0 !important;");
			}, 500);
		}
		if ($.gPref("pShowToolbarsOnMouseOver")) {
			$.handleToolbars("hide");
			$.handleSelfListeners();
		}
		$.createElements();
		$.handlePrefObserver();

		if ("CustomizableUI" in window) {
			if (!window[$._UID]["CustomizableUI"]) {
				window[$._UID]["CustomizableUI"] = true;
				CustomizableUI.addListener({
					onCustomizeEnd: function(aWindow) {
						var thisBtn = aWindow.document.getElementById(self.id);
						setTimeout(function() {
							aWindow[$._UID]["CustomizableUI"] && thisBtn.ToolbarsToggler.softSelfDestroy();
						}, Math.floor(Math.random() * (1 + 2000 - 200)) + 200);
					}
				});
			}
		}

		addDestructor(function(aReason) {
			if (aReason === "delete" || aReason === "update") {
				let selfEls = document.getElementsByAttribute("cb_id", $._UID);
				Array.prototype.slice.call(selfEls).forEach(function(aEl) { // Delete all elements created by this button.
					aEl && aEl.parentNode.removeChild(aEl);
				});
				$.handleGlobalListener(true);
				$.handlePrefObserver(true);
				$.handleSelfListeners(true);
			}
			if (aReason === "delete") {
				(Services.prefs.getBranch($.Branch)).deleteBranch("");
				Services.prefs.savePrefFile(null);
				delete window[$._UID];
			}
		});
	},

	hotkeyPressed: function() {
		$.handleToolbars("toggle");
	},

	createElements: function() {
		let popSet = document.getElementById("mainPopupSet");
		let tBM = document.getElementById($._UID + "_toolbar_selection_panel");
		if (popSet && !tBM) {
			popSet.appendChild($.$CNS("panel", {
				id: $._UID + "_toolbar_selection_panel",
				cb_id: $._UID,
				orient: "vertical",
				flex: 1,
				close: true,
				titlebar: "normal",
				level: "top",
				noautohide: true,
				oncommand: "event.stopPropagation();",
				onclick: "event.stopPropagation();",
				onpopuphidden: "document.getElementById('" + self.id +
					"').ToolbarsToggler.saveToolbarIDs(this);event.stopPropagation();",
				onpopupshowing: "document.getElementById('" + self.id +
					"').ToolbarsToggler.populateToolbarSelectionPanel(this);event.stopPropagation();",
				consumeoutsideclicks: false,
			}));
		}
	},

	populateToolbarSelectionPanel: function(aN) {
		aN.textContent = "";
		aN.label = "Available toolbars";

		aN.appendChild($.$CNS("description", {
			value: "Check the toolbars that you wish to control.",
			style: "font-weight:bold;"
		}));

		let controlledTBars = $.gPref("pToolbarIDs").split(",").filter(function(aVal) {
			if (aVal !== "")
				return true;
		});
		var grid = aN.appendChild($.$CNS("grid"));
		var cols = grid.appendChild($.$CNS("columns"));
		cols.appendChild($.$CNS("column", {
			flex: 1
		}));
		cols.appendChild($.$CNS("column", {
			flex: 1
		}));
		cols.appendChild($.$CNS("column", {
			flex: 1
		}));
		cols.appendChild($.$CNS("column", {
			flex: 1
		}));
		var rows = grid.appendChild($.$CNS("rows"));
		Array.prototype.slice.call($.getTogglableToolbars()).forEach(function(aEl) {
			let row = rows.appendChild($.$CNS("row", {
				align: "center"
			}));
			row.appendChild($.$CNS("checkbox", {
				checked: controlledTBars.indexOf(aEl.getAttribute("id")) !== -1,
				"data-toolbar-id": aEl.getAttribute("id"),
				label: aEl.getAttribute("toolbarname"),
				style: "font-weight:bold;"
			}));
			row.appendChild($.$CNS("label", {
				value: "ID:",
				style: "font-weight:bold;"
			}));
			row.appendChild($.$CNS("textbox", {
				value: aEl.getAttribute("id"),
				readonly: true,
			}));
		});
		aN.appendChild($.$CNS("description", {
			value: "Changes will be saved when this panel is closed.",
			style: "font-weight:bold;"
		}));
	},

	saveToolbarIDs: function(aNode) {
		let cBoxes = aNode.getElementsByTagName("checkbox");
		let newControlledTBarIDs = [];
		try {
			let checkedCBoxes = Array.prototype.slice.call(cBoxes).filter(function(aCBox) {
				if (aCBox.checked)
					return true;
			});
			checkedCBoxes.forEach(function(aCB) {
				newControlledTBarIDs.push(aCB.getAttribute("data-toolbar-id"));
			});
		} finally {
			$.sPref("pToolbarIDs", newControlledTBarIDs.join(","));
		}
	},

	chooseToolbars: function() {
		let p = document.getElementById($._UID + "_toolbar_selection_panel");
		p && p.openPopupAtScreen((screen.availWidth / 2), (screen.availHeight / 2), false);
	},

	openOptions: function() {
		var url = "about:config?filter=" + $.Branch;
		if ($.gPref("zOpenOptionsInTab") && ("gBrowser" in window)) {
			let tab = gBrowser.visibleTabs.find(tab => tab.linkedBrowser.currentURI.spec === url);
			gBrowser.selectedTab = tab || gBrowser.addTab(url);
		} else
			toOpenWindowByType("Preferences:ConfigManager", url);
	},

	onMouseOver: function(aE) {
		aE.preventDefault();
		$.mouseoverAction = function() {
			$.handleToolbars("show");
		};
		setTimeout(function() {
			$.mouseoverAction && $.mouseoverAction();
			$.handleGlobalListener();
		}, $.gPref("pShowToolbarsOnMouseOverDelay"));
		aE.stopPropagation();
	},

	onMouseOut: function(aE) {
		aE.preventDefault();
		$.mouseoverAction = null;
		aE.stopPropagation();
	},

	handleSelfListeners: function(aRem) {
		self.removeEventListener("mouseover", $.onMouseOver, false);
		self.removeEventListener("mouseout", $.onMouseOut, false);
		if (aRem)
			return true;
		if ($.gPref("pShowToolbarsOnMouseOver")) {
			self.addEventListener("mouseover", $.onMouseOver, false);
			self.addEventListener("mouseout", $.onMouseOut, false);
		}
	},

	handleToolbars: function(aHandle) {
		var tBarIDs = $.gPref("pToolbarIDs").split(",").filter(function(aVal) {
			if (aVal !== "")
				return true;
		});
		var CUI = "CustomizableUI" in window,
			STV = "setToolbarVisibility" in window;
		for (var i = tBarIDs.length - 1; i >= 0; i--) {
			let tBar = document.getElementById(tBarIDs[i]);
			if (tBar) {
				switch (aHandle) {
					case "show":
						if (CUI)
							CustomizableUI.setToolbarVisibility(tBar.id, true);
						else if (STV)
							window.setToolbarVisibility(tBar, true);
						else
							tBar.setAttribute("hidden", false);
						break;
					case "hide":
						if (CUI)
							CustomizableUI.setToolbarVisibility(tBar.id, false);
						else if (STV)
							window.setToolbarVisibility(tBar, false);
						else
							tBar.setAttribute("hidden", true);
						break;
					case "toggle":
						if (CUI)
							CustomizableUI.setToolbarVisibility(tBar.id, tBar.collapsed);
						else if (STV)
							window.setToolbarVisibility(tBar,
								tBar.getAttribute("collapsed") === "true" ? true : false);
						else
							tBar.setAttribute("hidden",
								tBar.getAttribute("hidden") === "true" ? false : true);
						break;
				}
			}
		}
	},

	globalListener: function(aE) {
		var isChild = $.isChild(aE.target),
			keepIpOpen = false;
		if ((aE.button === 2 || aE.button === 1) && isChild)
			return;
		if (!!aE.target.childNodes) {
			var cNodes = aE.target.childNodes.length,
				i = 0;
			for (; i < cNodes; i++) {
				let nodeName = aE.target.childNodes[i].nodeName;
				if (nodeName === "menupopup" || nodeName === "popup" || nodeName === "panel")
					keepIpOpen = true;
				break;
			}
		}
		if (!isChild)
			keepIpOpen = false;
		if (keepIpOpen)
			return;
		$.handleToolbars("hide");
		$.handleGlobalListener(true);
	},

	handleGlobalListener: function(aRem) {
		window.removeEventListener("mouseup", $.globalListener, false);
		if (aRem)
			return;
		setTimeout(function() {
			window.addEventListener("mouseup", $.globalListener, false);
		}, 10);
	},

	isChild: function(aTargetNode) {
		if (!aTargetNode)
			return false;
		var tBarIDs = $.gPref("pToolbarIDs").split(",").filter(function(aVal) {
			if (aVal !== "")
				return true;
		});
		for (var i = tBarIDs.length - 1; i >= 0; i--) {
			if (document.getElementById(tBarIDs[i]).contains(aTargetNode))
				return true;
		}
		return false;
	},

	handlePrefObserver: function(aRem) {
		var prefs = $.DefPrefs;
		for (let key in prefs) {
			let pref = $.Branch + key;
			if (prefs.hasOwnProperty(key)) {
				if (aRem)
					Services.prefs.removeObserver(pref, $.prefObserver, false);
				else
					Services.prefs.addObserver(pref, $.prefObserver, false);
			}
		}
	},

	prefObserver: {
		observe: function(aSubject, aTopic, aPStr) {
			if (aTopic === "nsPref:changed") {
				switch (aPStr.slice($.Branch.length)) {
					case "pHideButtonImage":
						$.hardSelfDestroy();
						break;
					case "pShowToolbarsOnMouseOver":
						$.handleToolbars("hide");
						$.handleSelfListeners();
						break;
				}
			}
		}
	},

	/**
	 * [hardSelfDestroy description]
	 * The self.destroy + self.init combination is not gonna cut it here when showing/hiding button image.
	 */
	hardSelfDestroy: function() {
		var initCode = self.cbInitCode;
		var link = custombuttons.makeButtonLink("edit", self.id);
		var cbService = custombuttons.cbService;
		var param = cbService.getButtonParameters(link);
		param = param.wrappedJSObject || param;
		param.initCode = initCode;
		cbService.installButton(param);
	},

	softSelfDestroy: function() {
		setTimeout(function() {
			self.destroy("update");
			setTimeout(function() {
				self.init();
			}, 100);
		}, 100);
	},

	getTogglableToolbars: function() {
		let toolbarNodes;
		if ("gNavToolbox" in window) {
			toolbarNodes = Array.slice(gNavToolbox.childNodes);
			toolbarNodes = toolbarNodes.concat(gNavToolbox.externalToolbars);
		} else
			toolbarNodes = Array.slice(document.getElementsByTagName("toolbar"));

		toolbarNodes = toolbarNodes.filter(node => node.getAttribute("toolbarname"));
		return toolbarNodes;

	},

	$CNS: function(aElName, aAttrs, aNameSpace) { // Creates elements
		var el = aNameSpace ?
			document.createElementNS(aNameSpace, aElName) :
			document.createElement(aElName);
		if (aAttrs)
			Object.keys(aAttrs).forEach(function(n) {
				if (aAttrs[n] !== "")
					el.setAttribute(n, aAttrs[n]);
			});
		return el;
	},
	accel: function(aE) {
		if (aE)
			return $.isOSX ? aE.metaKey : aE.ctrlKey;
		return $.isOSX ? "𝗖𝗼𝗺𝗺𝗮𝗻𝗱" : "𝗖𝗼𝗻𝘁𝗿𝗼𝗹";
	},
	isOSX: Services.appinfo.OS.toLowerCase().startsWith("darwin"),
	mouseoverAction: null,
	_UID: "__auto_hide_toolbars_" + self.id.slice(20),

};

this.ToolbarsToggler.gPref = function(aKey) {
	let branch = Services.prefs.getBranch(self.ToolbarsToggler.Branch);
	switch (typeof self.ToolbarsToggler.DefPrefs[aKey]) {
		case "boolean":
			return branch.getBoolPref(aKey);
		case "number":
			return branch.getIntPref(aKey);
		case "string":
			return branch.getComplexValue(aKey, Ci.nsISupportsString).data;
	}
	return null;
};

this.ToolbarsToggler.sPref = function(aKey, aVal) {
	let branch = Services.prefs.getBranch(self.ToolbarsToggler.Branch);
	switch (typeof aVal) {
		case "boolean":
			branch.setBoolPref(aKey, aVal);
			break;
		case "number":
			branch.setIntPref(aKey, aVal);
			break;
		case "string":
			let str = Cc["@mozilla.org/supports-string;1"].createInstance(Ci.nsISupportsString);
			str.data = aVal;
			branch.setComplexValue((aKey), Ci.nsISupportsString, str);
			break;
	}
};

this.ToolbarsToggler.initPrefs = function() {
	let branch = Services.prefs.getDefaultBranch(self.ToolbarsToggler.Branch),
		defaults = self.ToolbarsToggler.DefPrefs;
	for (let key in defaults) {
		if (defaults.hasOwnProperty(key)) {
			let val = defaults[key];
			switch (typeof val) {
				case "boolean":
					branch.setBoolPref(key, val);
					break;
				case "number":
					branch.setIntPref(key, val);
					break;
				case "string":
					let str = Cc["@mozilla.org/supports-string;1"].createInstance(Ci.nsISupportsString);
					str.data = val;
					branch.setComplexValue((key),
						Ci.nsISupportsString, str);
					break;
			}
		}
	}
};

this.ToolbarsToggler.Branch = "CB.ToolbarsToggler.Id" + self.id.slice(20) + ".";

this.ToolbarsToggler.DefPrefs = {
	pShowToolbarsOnMouseOver: false,
	pShowToolbarsOnMouseOverDelay: 200,
	pToolbarIDs: "PersonalToolbar",
	pHideButtonImage: false,
};

this.ToolbarsToggler.init();]]></initcode>
  <code><![CDATA[if(!event.target && !this.disabled)
	this.AutoHideToolbars.hotkeyPressed();
]]></code>
  <accelkey><![CDATA[Ctrl+Shift+V]]></accelkey>
  <help><![CDATA[]]></help>
  <attributes/>
</custombutton>